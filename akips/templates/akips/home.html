{% extends 'akips/base.html' %}
{% load static %}

{% block title %}OCNES Dashboard{% endblock %}
{% block extra_head%}
<!-- <meta http-equiv="refresh" content="30"> -->
{% endblock %}

{% block content %}
<form method="get" action="/incident/">

    <div id="chart" class="card">
        <div class="card-header">
            <h3 class="card-title">Event Trends</h3>
        </div>
        <div class="card-body p-0">
            <div class="chart">
                <div class="chartjs-size-monitor">
                    <div class="chartjs-size-monitor-expand">
                        <div class=""></div>
                    </div>
                    <div class="chartjs-size-monitor-shrink">
                        <div class=""></div>
                    </div>
                </div>
            <!-- <canvas id="areaChart" style="min-height: 100px; height: 100px; max-height: 100px; max-width: 100%; display: block; width: 381px;" width="381" height="250" class="chartjs-render-monitor"></canvas> -->
            <canvas id="barChart" style="min-height: 100px; height: 100px; max-height: 100px; max-width: 100%; display: block; width: 414px;" width="414" height="250" class="chartjs-render-monitor"></canvas>
            </div>
        </div>
    </div>

    <div id="crit_card" class="card card-primary event-card" data-url="{% url 'crit_card' %}">
        <div class="card-body table-responsive p-0">
        </div>
    </div>

    <div id="bldg_card" class="card card-primary event-card" data-url="{% url 'bldg_card' %}">
        <div class="card-body table-responsive p-0">
        </div>
    </div>

    <div id="trap_card" class="card card-primary event-card" data-url="{% url 'trap_card' %}">
        <div class="card-body table-responsive p-0">
        </div>
    </div>

    <div class="text-right p-3">
        <button type="submit" id="incident_button" class="btn btn-primary">Create Incident</button>
    </div>

    <!-- <audio id="audiotag1" src="{% static 'akips/sound/mixkit-wrong-answer-fail-notification-946.wav' %}"
        preload="auto"></audio>
    <a href="javascript:play_single_sound();">Test sound</a> -->
</form>
{% endblock %}

{% block js %}
<script src="{% static 'admin-lte/plugins/chart.js/Chart.min.js' %}"></script>
<script type="text/javascript">
    function play_single_sound() {
        document.getElementById('audiotag1').play();
    }
    function voice_alert(text) {
        var msg = new SpeechSynthesisUtterance(text);
        speechSynthesis.speak(msg);
    }
    function update_chart() {
        /* ChartJS
        * -------
        * Here we will create a few charts using ChartJS
        */
    
        //--------------
        //- AREA CHART -
        //--------------
    
        // Get context with jQuery - using jQuery's .get() method.
        //var areaChartCanvas = $('#areaChart').get(0).getContext('2d')
    
        var areaChartData = {
            //labels  : ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '00:00'],
            labels  : [],
            datasets: [
            {
                label               : 'New Unreachables',
                backgroundColor     : 'rgba(60,141,188,0.9)',
                borderColor         : 'rgba(60,141,188,0.8)',
                pointRadius          : false,
                pointColor          : '#3b8bba',
                pointStrokeColor    : 'rgba(60,141,188,1)',
                pointHighlightFill  : '#fff',
                pointHighlightStroke: 'rgba(60,141,188,1)',
                //data                : [28, 48, 40, 19, 86, 27, 90]
                data                : []
            },
            {
                label               : 'New Traps',
                backgroundColor     : 'rgba(210,214,222,1)',
                borderColor         : 'rgba(210,214,222,1)',
                pointRadius          : false,
                pointColor          : 'rgba(210, 214, 222, 1)',
                pointStrokeColor    : '#c1c7d1',
                pointHighlightFill  : '#fff',
                pointHighlightStroke: 'rgba(220,220,220,1)',
                //data                : [28, 48, 40, 19, 86, 27, 90]
                data                : []
            },
            ]
        }
    
        // var areaChartOptions = {
        //     maintainAspectRatio : false,
        //     responsive : true,
        //     legend: {
        //     display: false
        //     },
        //     scales: {
        //         xAxes: [{
        //             gridLines : {
        //             display : false,
        //             }
        //         }],
        //         yAxes: [{
        //             gridLines : {
        //             display : false,
        //             }
        //         }]
        //     }
        // }
    
        // This will get the first returned node in the jQuery collection.
        // var chart = new Chart(areaChartCanvas, {
        //     type: 'line',
        //     data: areaChartData,
        //     options: areaChartOptions
        // })

        // Bar Chart
        var barChartCanvas = $('#barChart').get(0).getContext('2d');
        var barChartData = $.extend(true, {}, areaChartData)
        var temp0 = areaChartData.datasets[0]
        var temp1 = areaChartData.datasets[1]
        
        var barChartOptions = {
            maintainAspectRatio : false,
            response : true,
            legend: {
                display: false
            },
            datasetFill : false,
            scales: {
                y: {
                    suggestedMin: 0
                },
                xAxes: [{
                    gridLines : {
                        display : true
                    }
                }],
                yAxes: [{
                    // ticks: {
                    //     stepSize: 1
                    // },
                    gridLines : {
                        display : true
                    }
                }]
            }
        }

        var barchart = new Chart(barChartCanvas, {
            type: 'bar',
            data: barChartData,
            options: barChartOptions
        })

        $.ajax({
            type: "GET",
            url: '/chart/',
            dataType: "json",
            data: {},
            success: function (result, status, xhr) {
                barchart.data.labels = result['chart_labels'];
                barchart.data.datasets[0].data = result['chart_event_data'];
                barchart.data.datasets[1].data = result['chart_trap_data'];
                barchart.update();
            },
            error: function (xhr, status, error) {

            }
        });
    }
</script>
<script type="text/javascript">
    function refresh_cards() {
        var overlay = '<div class="overlay"><i class="fas fa-2x fa-sync-alt fa-spin"></i></div>';

        $('.event-card').each(function (index) {
            var id = this.id;
            var url = $(this).data("url");
            var body = $(this).find(".card-body");
            var body_clone = body.clone();
            body.append(overlay);

            $.ajax({
                type: "GET",
                url: url,
                dataType: "html",
                data: {},
                success: function (result, status, xhr) {
                    body.html(result);
                    var new_event = body.find('.akips_trend:contains(New)').length;
                    var inc_event = body.find('.akips_trend:contains(Increasing)').length;
                    var stable_event = body.find('.akips_trend:contains(Stable)').length;
                    if (id == 'crit_card') {
                        if (new_event > 0) {
                            voice_alert("There are " + new_event + " new critical alerts.");
                        }
                    } else if (id == 'bldg_card') {
                        if (new_event > 0) {
                            voice_alert("There are " + new_event + " new building alerts.");
                        }
                        if (inc_event > 0) {
                            voice_alert("There are " + inc_event + " increasing building alerts.");
                        }
                    } else if (id == 'trap_card') {
                        if (new_event > 0) {
                            voice_alert("There are " + new_event + " new trap alerts.");
                        }
                    }
                    // body.find('.akips_trend:contains(New), .akips_trend:contains(Increasing)').each(function( index ) {
                    //     document.getElementById('audiotag1').play();
                    // });
                },
                error: function (xhr, status, error) {
                    body.replaceWith(body_clone);
                    body.append('<div class="overlay text-danger">Failed to get update: ' + error + '</div>');
                }
            });
        });

    }
</script>
<script type="text/javascript">
    $(document).ready(function () {
        var refresh_seconds = 30000;

        // Populate the page content for the first time
        refresh_cards();
        update_chart();

        // $('.akips_trend:contains(New)').each(function( index ) {
        //     document.getElementById('audiotag1').play();
        // });

        var username = $('#username').text()
        //var msg = new SpeechSynthesisUtterance("Greetings " + username);
        var msg = new SpeechSynthesisUtterance("Kenan-Football-Center and Knapp-Sanders-Building");
        //speechSynthesis.speak(msg);

        // Bind to the document so dynamicly added content will still work
        // Configure the ACK switch for events
        $(document).on('change', 'input.ack-switch', function () {
            var url = $(this).data("url");
            if (this.checked) {
                console.log("ack checkbox on");
                $.get(url, { "ack": 'True' })
            } else {
                console.log("ack checkbox off")
                $.get(url, { "ack": 'False' })
            }
        });

        // Bind to the document so dynamicly added content will still work
        // Configure the ACK switch for traps
        $(document).on('change', 'input.ack-trap', function () {
            var url = $(this).data("url");
            if (this.checked) {
                console.log("ack checkbox on");
                $.get(url, { "ack": 'True' })
            } else {
                console.log("ack checkbox off")
                $.get(url, { "ack": 'False' })
            }
        });

        // Bind to the document so dynamicly added content will still work
        // Configure the Clear Trap button for traps
        $(document).on('click', 'button.trap-clear', function () {
            //$(this).prop('disabled', true);
            var tr = $(this).closest('tr');
            var url = $(this).data("url");
            $.get(url, {})

            tr.css("background-color", "#FF3700");
            tr.fadeOut(400, function () {
                tr.remove();
            });
        });

        // Configure the Create Incident button for events and traps
        $('#incident_button').click(function () {
            checked = $("input[name=event]:checked").length;
            if (!checked) {
                alert("Please select one summary to create an incident.");
                return false;
            }
        });

        // Update the page content on a dynamic refresh interval
        var intervalId = window.setInterval(function () {
            refresh_cards();
            update_chart();
        }, refresh_seconds);

        // Chart section

    })
</script>
{% endblock %}