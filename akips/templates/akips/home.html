{% extends 'akips/base.html' %}
{% load static %}

{% block title %}OCNES Dashboard{% endblock %}
{% block extra_head%}
<!-- <meta http-equiv="refresh" content="30"> -->
{% endblock %}

{% block content %}
<form method="get" action="/incident/">

<div id="crit_card" class="card card-primary event-card" data-url="{% url 'crit_card' %}">
    <div class="card-body table-responsive p-0">
    </div>
</div>

<div id="bldg_card" class="card card-primary event-card" data-url="{% url 'bldg_card' %}">
    <div class="card-body table-responsive p-0">
    </div>
</div>

<div class="card">
    <div class="card-body table-responsive p-0">
        <table class="table table-hover table-sm">
            <thead>
                <tr>
                    <th>Ack</th>
                    <th>Device</th>
                    <th>Trap</th>
                    <th>Recorded</th>
                    <th>Incident Request</th>
                    <th>Clear Trap</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <div class="custom-control custom-switch">
                            {% if bldg.ack %}
                            <input type="checkbox" class="custom-control-input" id="ack-switch-1" data-url="{% url 'ack' 1 %}" checked>
                            {% else %}
                            <input type="checkbox" class="custom-control-input" id="ack-switch-1" data-url="{% url 'ack' 1 %}" >
                            {% endif %}
                            <label class="custom-control-label" for="ack-switch-1"></label>
                        </div>
                    </td>
                    <td>152.2.255.101</td>
                    <td>SNMPv2-MIB.snmpTrapOID: OSPF-TRAP-MIB.ospfNbrStateChange</td>
                    <td>Sept. 15, 2022, 8:33 a.m.</td>
                    <td class="text-center">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="incident_{{ trap.id }}">
                        </div>
                    </td>
                    <td><button type="button" class="btn btn-primary btn-sm">Clear Trap</button></td>
                </tr>
                {% for trap in traps %}
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="text-right">
    <button type="submit" id="incident_button" class="btn btn-primary">Create Incident</button>
</div>

<audio id="audiotag1" src="{% static 'akips/sound/mixkit-wrong-answer-fail-notification-946.wav' %}" preload="auto"></audio>
<a href="javascript:play_single_sound();">Test sound</a>
</form>
{% endblock %}

{% block js %}
<script type="text/javascript">
	function play_single_sound() {
		document.getElementById('audiotag1').play();
	}
</script>
<script type="text/javascript">
	function refresh_cards() {
        var overlay = '<div class="overlay"><i class="fas fa-2x fa-sync-alt fa-spin"></i></div>';

        $('.event-card').each(function( index ) {
            var url = $(this).data("url");
            var body = $(this).find(".card-body");
            var body_clone = body.clone();
            body.append(overlay);

            $.ajax({
            type: "GET",
            url: url,
            dataType: "html",
            data: {},
            success: function (result, status, xhr) {
                body.html(result);
                body.find('.akips_trend:contains(New), .akips_trend:contains(Increasing)').each(function( index ) {
                    document.getElementById('audiotag1').play();
                });
            },
            error: function (xhr, status, error) {
                body.replaceWith(body_clone);
                body.append('<div class="overlay text-danger">Failed to get update: ' + error + '</div>');
            }
            });
        });
	}
</script>
<script type="text/javascript">
    $(document).ready(function() {
        var refresh_seconds = 30000;

        refresh_cards();

        // $('.akips_trend:contains(New)').each(function( index ) {
		//     document.getElementById('audiotag1').play();
        // });

        var intervalId = window.setInterval(function(){
            refresh_cards();
        }, refresh_seconds);

        // Bind to the document so dynamicly added content will still work
        $(document).on('change', 'input.ack-switch', function() {
            var url = $(this).data("url");
            if(this.checked) {
                console.log("ack checkbox on");
                $.get(url, { "ack": 'True'})
            } else {
                console.log("ack checkbox off")
                $.get(url, { "ack": 'False'})
            }
        });

        $('#incident_button').click(function() {
            checked = $("input[name=event]:checked").length;
            if (!checked) {
                alert("Please select one summary to create an incident.");
                return false;
            }
        });
    })
</script>
{% endblock %}